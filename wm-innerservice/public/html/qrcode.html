<!DOCTYPE html
	PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh-CN" lang="zh-CN">

<head>
	<title>WMS QRCode</title>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
	<script type="text/javascript" src="/static/js/jquery.min.js"></script>
	<script type="text/javascript" src="/static/js/qrcode.js"></script>
	<style>
		body,
		html {
			height: 100%;
			margin: 0;
		}

		.my_container {
			display: flex;
			justify-content: start;
			align-items: start;
			height: auto;
		}
	</style>
</head>

<body>
	<input id="text" type="text" value="" style="width:80%;margin-top:50px;" /><br />
	<div class="my_container">
		<div id="qrcode" style="width:200px; height:200px; margin-top:15px;"></div>
		<canvas id="percentageCircle" width="200" height="200" style="margin-top:15px;"></canvas>
	</div>

	<p id="login-status"></p>
	<button type="button" onclick="wmLogin()">Login</button>
	<p id="servertime">undefined</p>

	<script type="text/javascript">
		var qrcode = new QRCode(document.getElementById("qrcode"), {
			width: 200,
			height: 200
		});

		const canvas = document.getElementById("percentageCircle");
		const ctx = canvas.getContext("2d");
		const centerX = canvas.width / 2;
		const centerY = canvas.height / 2;
		const radius = 50;

		function drawCircle(percentage) {
			ctx.clearRect(0, 0, canvas.width, canvas.height);

			// Draw background circle
			ctx.beginPath();
			ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
			ctx.strokeStyle = `hsl(${120 * (1 - percentage)}, 100%, 50%)`; // Interpolate color from green to red
			ctx.lineWidth = 100;
			ctx.stroke();

			// Draw progress circle
			ctx.beginPath();
			ctx.arc(centerX, centerY, radius, -0.5 * Math.PI, (-0.5 + 2 * percentage) * Math.PI);
			ctx.strokeStyle = "#ffffff"
			ctx.lineWidth = 100;
			ctx.stroke();
		}

		var _qrdata = undefined;
		const IP = 'wms.myawesome.top:3000';
		const QRURL = `http://${IP}/qrcode`;
		const LOGIN_URL = `http://${IP}/login`;
		const LOGIN_QUERY_URL = `http://${IP}/login`;
		const SERVER_TIME_URL = `http://${IP}/runtime`;

		function wmLogin() {
			var elText = document.getElementById("text");
			$.ajax({
				url: LOGIN_URL + `?code=${elText.value.trim()}`,
				type: "post",
				success: function (data) {
					alert(`login success with ${data}`);
				}
			})
			console.log(`wm login ${elText.value.trim()}`);
		}

		function makeCode() {
			if (_qrdata != undefined) {
				qrcode.makeCode(_qrdata.data.qrcontent);
			}
		}

		function ajaxMadeCode() {
			$.ajax({
				url: QRURL,
				success: function (data) {
					if (_qrdata == undefined || data.data.qrcontent != _qrdata.data.qrcontent) {
						// _qrCode = data.data.qrcontent;
						_qrdata = data;
						console.log(`refresh qrcode ${_qrdata.data.qrcontent} at ${new Date()}`);
					}
					makeCode();
				}
			});
		}

		ajaxMadeCode();
		setInterval(() => {
			ajaxMadeCode();
		}, 1000);

		$("#text").
			on("blur", function () {
				makeCode();
			}).
			on("keydown", function (e) {
				if (e.keyCode == 13) {
					makeCode();
				}
			});
	</script>

	<script>

		function rgbToHsl(r, g, b) {
			r /= 255, g /= 255, b /= 255;
			const max = Math.max(r, g, b), min = Math.min(r, g, b);
			let h, s, l = (max + min) / 2;

			if (max == min) {
				h = s = 0;
			} else {
				const d = max - min;
				s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
				switch (max) {
					case r: h = (g - b) / d + (g < b ? 6 : 0); break;
					case g: h = (b - r) / d + 2; break;
					case b: h = (r - g) / d + 4; break;
				}
				h /= 6;
			}

			return [h, s, l];
		}

		function hslToRgb(h, s, l) {
			let r, g, b;

			if (s == 0) {
				r = g = b = l;
			} else {
				const hue2rgb = (p, q, t) => {
					if (t < 0) t += 1;
					if (t > 1) t -= 1;
					if (t < 1 / 6) return p + (q - p) * 6 * t;
					if (t < 1 / 2) return q;
					if (t < 2 / 3) return p + (q - p) * (2 / 3 - t) * 6;
					return p;
				};

				const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
				const p = 2 * l - q;
				r = hue2rgb(p, q, h + 1 / 3);
				g = hue2rgb(p, q, h);
				b = hue2rgb(p, q, h - 1 / 3);
			}

			return [r * 255, g * 255, b * 255];
		}

		function lerp(a, b, t) {
			return a + (b - a) * t;
		}

		function lerpColor(color1, color2, t) {
			const hsl1 = rgbToHsl(...color1);
			const hsl2 = rgbToHsl(...color2);

			const h = lerp(hsl1[0], hsl2[0], t);
			const s = lerp(hsl1[1], hsl2[1], t);
			const l = lerp(hsl1[2], hsl2[2], t);

			return hslToRgb(h, s, l);
		}

		function rgbToHex(rgb) {
			return '#' + rgb.map(x => {
				const hex = x.toString(16);
				return hex.length === 1 ? '0' + hex : hex;
			}).join('');
		}

		function updateCircle(percent) {
			drawCircle(percent);
		}

		setInterval(function () {
			if (_qrdata == undefined) {
				updateCircle(1.0);
			} else {
				let t = (_qrdata.QrTimeMs - (Date.now() - _qrdata.ctime)) / 1000;
				if (t <= 0) {
					t = 0;
					ajaxMadeCode();
				}
				updateCircle((Date.now() - _qrdata.ctime) / _qrdata.QrTimeMs);
			}
		}, 100);

		function getServerTime(data) {
			if (data < 0) {
				return "server is down!";
			} else {
				const seconds = data / 1000;
				const hours = Math.floor(seconds / 3600);
				const minutes = Math.floor((seconds % 3600) / 60);
				const remainingSeconds = seconds % 60;
				return `${hours.toString().padStart(6, '0')}H:${minutes.toString().padStart(2, '0')}M:${remainingSeconds.toFixed(2).padStart(2, '0')}S`;
			}
		}

		setInterval(function () {
			$.ajax({
				url: SERVER_TIME_URL,
				success: function (data) {
					document.getElementById("servertime").innerHTML = getServerTime(data);
				},
				error: function (xhr, textStatus, err) {
					document.getElementById("servertime").innerHTML = "failed to connect server";
				}
			});
		}, 100);

		// 
		var _login_status = undefined;
		const _lgStatusInterval = setInterval(function () {
			$.ajax({
				url: LOGIN_QUERY_URL,
				success: function (data) {
					if (data != undefined) {
						_login_status = data;
					}
				}
			});
			if (_login_status != undefined) {
				document.getElementById("login-status").innerHTML = `login: ${_login_status.scriptReqTimes}<br> logout: ${_login_status.logoutReqTimes}<br> token: ${_login_status.iPlanetDirectoryPro}`;
			}
		}, 1000);
	</script>
</body>